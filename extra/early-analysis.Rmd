---
title: "Analysis of data"
author: "Micaiah Balonek"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, warning = FALSE, echo = FALSE)
```

```{r load-packages, message = FALSE}
library(tidyverse)
library(broom)
library(scales)
library(plotly)
```

```{r load-data}
setwd("/cloud/project/data")
gravity_spy_metadata <- read_csv("trainingset_v1d1_metadata.csv", show_col_types = FALSE) %>%
  select(-c(8, 9, 14, 17, 18, 19, 20)) %>%
  mutate(phase = param_one_value, .keep = "unused")
```

To start our preliminary analysis of the data, we plot how common each of these glitches are compared to eachother in each interferometer:

```{r glitch-frequency}
customGlitchColour <- c("#ff0000", "#ff8800", "#ffff00","#88ff00", "#00ff00", "#00ffff", "#0088ff", "#0000ff", "#8800ff", "#ff00ff", "#ff0088", "#ffffff", "#aaaaaa", "#ff88bb", "#ffbb88", "#ffff88","#bbff88", "#88ffff", "#88bbff", "#8888ff", "#bb88ff", "#ff88ff")
gravity_spy_metadata %>%
  ggplot(aes(x = ifo, fill = label)) +
    scale_fill_manual(values = customGlitchColour) +
    geom_bar(position = "stack") +
    labs(title = "Glitch frequency", subtitle = "in each of the LIGO interferometers", fill = "Glitch class", x = "interferometer")
```

First of all, we can see that several glitch classes are specific to each interferometer (although some may just have few enough examples that they don't show up in this graph). Another interesting thing to see is that Hanford generally has more glitches than Livingston, and that Blips, Koi Fish, and Low-Frequency Bursts appear to be the glitches with the most examples. To see whether this is accurate, we will now calculate summary statistics for each glitch class. The following summary statistics include the number of glitches of that class detected in each interferometer (columns `n_H1` and `n_L1`) and the means of each of the predictor variables for each class.

```{r glitch-class-stats}
glitch_class_summary <- gravity_spy_metadata %>%
  group_by(label) %>%
  summarise(snr=round(10*mean(snr))/10, peak_freq = round(mean(peak_frequency)), central_freq = round(mean(central_freq)), duration = round(100*mean(duration))/100, bandwidth = round(mean(bandwidth)))

gravity_spy_metadata %>%
  group_by(label) %>%
  count(ifo) %>%
  pivot_wider(names_from = ifo, values_from = n) %>%
  mutate(n_H1 = if_else(is.na(H1), 0, H1), n_L1 = if_else(is.na(L1), 0, L1), .keep = "unused") %>%
  inner_join(glitch_class_summary, by = "label") %>%
  ungroup() %>%
  print(n=22)
```

From this summary data, we can see that the Machine Learning system has classed several glitches into categories from the "wrong" observeratory. This can be explained in the following way: enough glitches happen that even if a certain glitch type isn't present in one interferometer, a burst of noise can appear with a random shape that the ML couldn't classify well into the "correct" interferometer's categories, and which happens to look like a glitch from another category, and would get classified into that; alternatively, since "None of the Above" is a category, this implies that the training data (classified by citizen scientists) is included in this dataset, and these mistakes were human errors, already present in the training data. We can also see that Koi Fish, one of the most prominent types of glitches, is also the loudest standard class (other than Extremely Loud glitches, which are the loudest by definition), while Scratchy, Helix, and Air Compressor glitches are the quietest, even quieter on average than the 'No glitch' category.

### Preliminary Analysis

To begin our analysis of the data points themselves (other than just the averages for each glitch class) we plot out `bandwidth` by `duration`, with the colour of the points representing the label, to see how well we can group glitch classes by the general dimensions of the signal:

```{r bandwidth-duration-plot}
gravity_spy_metadata %>%
  ggplot(aes(y = duration, x = bandwidth, colour = label)) +
    geom_point(size = 0.2) +
    scale_colour_manual(values = customGlitchColour) +
    theme_minimal() +
    theme(legend.key.size = unit(0.1, "cm")) +
    labs(title = "Glitch classes by duration and bandwidth", colour = "Glitch class")
```

This image is a bit hard to read, since the labels take up so much room, and since there are so many data points on the graph; still, one can tell that in the lower part of the distribution the glitch population is dominated by the blue and purple colours of Koi Fish, Low-Frequency Bursts, and Low-Frequency Lines, with a sudden stripe of green (and assorted other colours) at the very bottom. Zooming in on the y-axis to glitches with durations less than 5 seconds gives us the following plot:

```{r bandwidth-duration-plot-zoomed}
gravity_spy_metadata %>%
  ggplot(aes(y = duration, x = bandwidth, colour = label)) +
    geom_point(size = 0.2) +
    scale_colour_manual(values = customGlitchColour) +
    theme_minimal() +
    theme(legend.key.size = unit(0.1, "cm")) +
    labs(title = "Glitch classes by duration and bandwidth", subtitle = "Restricted to those with durations <= 5s", colour = "Glitch class") +
    ylim(0, 5)
```

With this zoomed-in visualisation, we can see that the data has some artefacts, causing the values to line up on a grid; ignoring this, however, we notice the large cluster of green "Blip"-type glitches at the bottom, especially prominent in the bottom-left corner, as well as two major populations of 1080-Lines: one forming linear patterns in the lower-right-hand corner of the distribution, and the other one being around the left-hand side of the blip distribution. We also see a population of either violin modes or wandering lines in the center of the lower edge of the plot, its density peaking at bandwidths between 3000 and 4000. We also now see that there are many Koi Fish glitches spread through the background distribution, which we mixed in with the colour of the low-frequency bursts and lines in our earlier analysis. The last notable point that stands out in this graph is the fact that Koi fish and Low Frequency Bursts seem to dominate for most of the chart, with assorted scattered-light glitches among them as well.

Meanwhile, if we instead plot peak frequency by duration (using the same limit on duration), we get the following graph:

```{r peakFreq-duration-plot}
gravity_spy_metadata %>%
  ggplot(aes(y = duration, x = peak_frequency, colour = label)) +
    geom_point(size = 0.2) +
    theme_minimal() +
    scale_colour_manual(values = customGlitchColour) +
    theme(legend.key.size = unit(0.1, "cm")) +
    labs(title = "Glitch classes by duration and peak frequency", x = "Peak frequency", colour = "Glitch class") +
  ylim(0, 5)
```

Here, we can clearly see spikes of 1080-Hz lines and 1400-Hz ripples at their respective frequencies, as well as several spikes of violin modes at frequencies just over 1000Hz, 1500Hz, and 2000Hz, among a background composed mostly of Whistles. Moving into lower frequencies, we see a cloud of Blips underneath another blob, mostly composed of Koi Fish. There are several distributions of other glitches at lower frequencies as well, but these are harder to see clearly because of how little room they take up on the graph; to solve this, we use the same transformation as the Gravity Spy spectrograms do: taking the logarithm of the frequency values.

```{r peakFreq-log-plot}
gravity_spy_metadata %>%
  ggplot(aes(y = duration, x = peak_frequency, colour = label)) +
    geom_point(size = 0.2) +
    theme_minimal() +
    scale_colour_manual(values = customGlitchColour) +
    theme(legend.key.size = unit(0.1, "cm")) +
    labs(title = "Glitch classes by duration and peak frequency", colour = "Glitch class", x = "Peak frequency (log scale)") +
    ylim(0, 5) +
    scale_x_continuous(transform = "log2", n.breaks = 10)
```

In this new graph, while we can still see the high-frequency spikes, we can now also see many lower-frequency trends (as well as similar gridline textures as in the previous diagrams). One of the most striking, in my opinion, is the line at 20Hz that seperates the low frequency lines and bursts from the scattered light glitches. There is a similar line on the other side of the scattered light glitches which seperates them from most other glitches (although there is a small area outside this line where there are scattered lights mixed with other glitch types, surprisingly enough still bounded by vertical lines). I have outlined these areas in the following plot: 

```{r peakFreq-log-plot-annotated-SL}
gravity_spy_metadata %>%
  ggplot(aes(y = duration, x = peak_frequency, colour = label)) +
    geom_point(size = 0.2) +
    scale_colour_manual(values = customGlitchColour) +
    theme_minimal() +
    theme(legend.key.size = unit(0.1, "cm")) +
    labs(title = "Glitch classes by duration and peak frequency", colour = "Glitch class", x = "Peak frequency (log scale)") +
    ylim(0, 5) +
    scale_x_continuous(transform = "log2", n.breaks = 10) +
    geom_segment(aes(x = 20, xend = 20, y = 1.1, yend = 5), colour = "black") +
    geom_segment(aes(x = 35, xend = 35, y = 0.75, yend = 5), colour = "grey50") +
  geom_segment(aes(x = 35, xend = 35, y = 0.75, yend = 1.5), colour = "black") +
  geom_segment(aes(x = 35, xend = 60, y = 1.5, yend = 2), colour = "grey50") +
  geom_segment(aes(x = 60, xend = 60, y = 2, yend = 5), colour = "grey50") +
  geom_segment(aes(x = 20, xend = 35, y = 1.1, yend = 0.75), colour = "black")
    
```

Moving back to the unmarked graph, we can see the 60Hz Power Line glitches as a line of orange-coloured points around the 60Hz-line, and the Air Compressor glitches as a similar, yellow line at around 45Hz. We also see that in this graph, blips are mostly found in a triangle from 40Hz to 700Hz, and with durations less than 1 second, with a cluster of Helixes in the center. The area above this triangle has a background patterned with the dark blues of Koi Fish and Light Modulation, the cyan colour of Scratchy glitches, and the pale blue of Tomtes. Restricting our graph to these types of glitches to get a better look at their distributions, we get the following graph:

```{r peakFreq-log-plot-bliplike}
gravity_spy_metadata %>%
  filter(label %in% list("Blip", "Helix", "Tomte", "Koi_Fish", "Light_Modulation", "Scratchy")) %>%
  ggplot(aes(y = duration, x = peak_frequency, colour = label)) +
    geom_point(size = 0.2) +
    theme_minimal() +
    scale_colour_manual(values = c("#ff0000", "#ffff00", "#00ff00", "#00ffff", "#0000ff", "#ff00ff")) +
    theme(legend.key.size = unit(0.1, "cm")) +
    labs(title = "Glitch classes by duration and peak frequency", colour = "Glitch class", x = "Peak frequency (log scale)") +
    ylim(0, 5) +
    scale_x_continuous(transform = "log2", n.breaks = 10)
```

Here, we can tell that Light Modulation has data points all across the graph, from around (1000, 0) to around (11, 5), while Tomtes are fairly localised between (32, 0) and (64, 1.3), with few exceptions. Helices are indeed clustered in the center of the Blip cluster, which is in most cases visibly seperate from the Koi Fish cluster, with Scratchy glitches being found throughout both of these.


Next, we plot out `SNR` by each of `duration` and `peak frequency`, and analyse the results of these graphs:

```{r snr-dura-plots}
gravity_spy_metadata %>%
  ggplot(aes(y = duration, x = snr, colour = label)) +
    geom_point(size = 0.2) +
    theme_minimal() +
    scale_colour_manual(values = customGlitchColour) +
    theme(legend.key.size = unit(0.1, "cm")) +
    labs(title = "Glitch classes by duration and Signal-to-noise ratio", colour = "Glitch class", x = "Signal-to-noise ratio") +
    ylim(0, 5) +
    scale_x_continuous(transform = "log10", n.breaks = 5)

gravity_spy_metadata %>%
  ggplot(aes(y = duration, x = snr, colour = label)) +
    geom_point(size = 0.2) +
    theme_minimal() +
    scale_colour_manual(values = customGlitchColour) +
    theme(legend.key.size = unit(0.1, "cm")) +
    labs(title = "Glitch classes by duration and Signal-to-noise ratio", subtitle = "without axis limits", colour = "Glitch class", x = "Signal-to-noise ratio (log scale)") +
    scale_x_continuous(transform = "log10", n.breaks = 5)

gravity_spy_metadata %>%
    ggplot(aes(y = snr, x = peak_frequency, colour = label)) +
    geom_point(size = 0.2) +
    theme_minimal() +
    scale_colour_manual(values = customGlitchColour) +
    theme(legend.key.size = unit(0.1, "cm")) +
    labs(title = "Glitch classes by peak frequency and signal-to-noise ratio", colour = "Glitch class", x = "Peak frequency (log scale)", y = "Signal-to-noise ratio") +
    scale_x_continuous(transform = "log2", n.breaks = 10) +
  scale_y_continuous(transform = "log10", n.breaks = 5)
```

From the first plot, we can see that, while blips, koi fish, and Extremely Loud glitches form visually distinct categories, most of the other glitch classes are in the same region as eachother. The second plot (which is basically just a zoomed-out version of the first plot) emphasises these four distributions, while also showing a notable second group of Extremely Loud glitches that intersect the 'other' distribution.
The third plot, however, is arguably the easiest graph to tell the different glitch classes apart on so far, with scratchy having a nearly-distinct region (although slightly overlapping with Helix and Blips), as well as Scattered Light (which has the most overlap with Tomtes, surprisingly) and most of the clusters from the `peak frequency`-`duration` plot, although seeming to mix up the other low-frequency glitches more than the original graph. To see whether we can combine all three of these variables into a single plot, we create a 3d visualisation of the data:

```{r}
gravity_spy_metadata %>%
  filter(duration <= 15) %>%
  plot_ly(x = ~log2(peak_frequency), y = ~duration, z = ~log10(snr), color = ~label, colors = customGlitchColour, size = 1, alpha = 0.3) %>%
  add_markers() %>%
  layout(scene = list(xaxis = list(title = "log_2(peak frequency)"),
                     yaxis = list(title = "duration"),
                     zaxis = list(title = "log_10(snr)")))
```

This interactive 3d chart is especially useful here, since we can isolate combinations of glitches and see the differences between them. For example, Blips and Koi fish can be seen to not only have a nearly-quadratic boundary in the `peak_frequency`-`snr` plane, but also that Koi Fish generally have longer durations than blips, sometimes dramatically so.